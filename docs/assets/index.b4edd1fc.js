var X=Object.defineProperty,Y=Object.defineProperties;var V=Object.getOwnPropertyDescriptors;var k=Object.getOwnPropertySymbols;var $=Object.prototype.hasOwnProperty,Z=Object.prototype.propertyIsEnumerable;var M=(s,t,e)=>t in s?X(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,f=(s,t)=>{for(var e in t||(t={}))$.call(t,e)&&M(s,e,t[e]);if(k)for(var e of k(t))Z.call(t,e)&&M(s,e,t[e]);return s},T=(s,t)=>Y(s,V(t));import{P as w}from"./phaser.e187d018.js";import{A as K}from"./phaser3-rex-plugins.3626259f.js";import{a as q}from"./astar-typescript.d7b2b5cc.js";import"./lodash.94525120.js";const J=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const n of o)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function e(o){const n={};return o.integrity&&(n.integrity=o.integrity),o.referrerpolicy&&(n.referrerPolicy=o.referrerpolicy),o.crossorigin==="use-credentials"?n.credentials="include":o.crossorigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(o){if(o.ep)return;o.ep=!0;const n=e(o);fetch(o.href,n)}};J();const u=10;class z{constructor(t=[]){this.emitOnAddTypes=t,this._events=new Map}on(t,e){var i;return this._events.has(t)||this._events.set(t,[]),(i=this._events.get(t))==null||i.push(e),this.emitOnAddTypes.indexOf(t)>=0&&e(),()=>{const o=this._events.get(t);this._events.set(t,o.filter(n=>n!=e))}}emit(t,e=void 0,i=void 0,o=void 0,n=void 0){var r;this._events.has(t)&&((r=this._events.get(t))==null||r.forEach(c=>c(e,i,o,n)))}}const S={x:0,y:0};class Q{constructor(t,e,i){this.input=t,this.scene=e,this.camera=i,this._events=new z,this._isHoldClick=!1,this._holdFrom=0,this._direction=S,this._position=S,console.log("Will use Mobile controls (touch)"),this.input.on("pointermove",this.onPointerMove.bind(this))}get controlType(){return j.Mobile}get direction(){const t=this._direction;return this._direction=S,t}update(t,e){const i=this._isHoldClick;if(this._isHoldClick=this.input.activePointer.leftButtonDown(),this._isHoldClick&&this._holdFrom===0&&(this._holdFrom=t),this._isHoldClick!==i){const{x:o,y:n}=this.input.activePointer.position;this._events.emit(A.Click,this._isHoldClick,(t-this._holdFrom)/1e3,{x:o,y:n})}!this._isHoldClick&&this._holdFrom>0&&(this._holdFrom=0)}on(t,e){return this._events.on(t,e)}onPointerMove(t){var e,i,o,n;if(!t.isDown){this._direction=S;return}this._direction={x:(t.x-t.prevPosition.x)/((i=(e=t==null?void 0:t.camera)==null?void 0:e.zoom)!=null?i:1)*-.4,y:(t.y-t.prevPosition.y)/((n=(o=t==null?void 0:t.camera)==null?void 0:o.zoom)!=null?n:1)*-.4},this._position={x:this._position.x-this._direction.x,y:this._position.y-this._direction.y}}}class tt{constructor(t){this.input=t,this._events=new z,this._isHoldClick=!1,this._direction={x:0,y:0},this._holdFrom=0,this.control_arrows=this.input.keyboard.createCursorKeys(),console.log("Will use PC controls (keyboard+mouse)")}get controlType(){return j.Pc}get direction(){return this._direction}update(t,e){this._direction=this.getArrowsDirection(),this._isHoldClick&&this._holdFrom===0&&(this._holdFrom=t);const i=this._isHoldClick;if(this._isHoldClick=this.input.activePointer.leftButtonDown(),this._isHoldClick!==i){const{x:o,y:n}=this.input.activePointer.position;this._events.emit(A.Click,this._isHoldClick,(t-this._holdFrom)/1e3,{x:o,y:n})}!this._isHoldClick&&this._holdFrom>0&&(this._holdFrom=0)}on(t,e){return this._events.on(t,e)}getArrowsDirection(){var i,o,n,r;let t=0,e=0;return(i=this.control_arrows)!=null&&i.left.isDown?t=-1:(o=this.control_arrows)!=null&&o.right.isDown&&(t=1),(n=this.control_arrows)!=null&&n.up.isDown?e=-1:(r=this.control_arrows)!=null&&r.down.isDown&&(e=1),{x:t,y:e}}}class et{constructor(t,e,i,o){this.systems=t,this.scene=e,this.input=i,this.camera=o,this.systems.game.device.os.desktop?this._playerInput=new tt(this.input):this._playerInput=new Q(this.input,this.scene,this.camera)}get direction(){return this._playerInput.direction}get controlType(){return this._playerInput.controlType}update(t,e){this._playerInput.update(t,e)}on(t,e){return this._playerInput.on(t,e)}}var j=(s=>(s[s.Unknown=0]="Unknown",s[s.Pc=1]="Pc",s[s.Mobile=2]="Mobile",s))(j||{}),A=(s=>(s[s.Unknown=0]="Unknown",s[s.Click=1]="Click",s))(A||{});class it{constructor(t,e,i,o,n,r){this.game=t,this.scale=e,this.camera=i,this.playerInput=o,this.gameSize=n,this.tileSize=r,this._x=0,this._y=0,this._pan={x:0,y:0},this.AllowedOffset=100,this._events=new z,this.camera.setSize(this.game.scale.width,this.game.scale.height),this.camera.setZoom(1)}get position(){return{x:this._x,y:this._y}}get events(){return this._events}setPosition(t,e){this._x=t,this._y=e}lookAt(t,e){const{width:i,height:o}=this.gameSize,{width:n,height:r}=this.scale.gameSize;this._x=Phaser.Math.Clamp(t-this._bounds.width/2-this.AllowedOffset/2,0,i-n-this.AllowedOffset+u),this._y=Phaser.Math.Clamp(e-this._bounds.height/2-this.AllowedOffset/2,0,o-r-this.AllowedOffset+u)}lookAtObject(t){const{x:e,y:i}=this.worldToTilePos(this.screenToBoundsPos(t.position));this.lookAt(e,i)}updatePosition(t,e){this._x=Phaser.Math.Clamp(this._x+t,0,this.gameSize.width-this._bounds.width-this.AllowedOffset+u),this._y=Phaser.Math.Clamp(this._y+e,0,this.gameSize.height-this._bounds.height-this.AllowedOffset+u)}update(t,e){var i;((i=this.playerInput)==null?void 0:i.controlType)===j.Pc?this.panWithMouseTick():this.camera.setScroll(this._x+this._pan.x,this._y+this._pan.y)}resize(t){this._bounds=t,this.camera.setBounds(0,0,this.gameSize.width+this._bounds.width-this.AllowedOffset+u,this.gameSize.height+this._bounds.height-this.AllowedOffset+u)}panWithMouseTick(){const{width:t,height:e}=this.scale.gameSize,{x:i,y:o}=this.game.input.activePointer.position,n=t-this._bounds.x*2,r=e-this._bounds.y*2;this._pan={x:Math.min(1,Math.max(0,i-this._bounds.x)/n)*this.AllowedOffset,y:Math.min(1,Math.max(0,o-this._bounds.y)/r)*this.AllowedOffset},this.camera.setScroll(this._x+this._pan.x,this._y+this._pan.y)}tryScreenToGamaPosition(t,e){const i={x:t.x+this._x+this._pan.x,y:t.y+this._y+this._pan.y};return i.x>this._bounds.x&&i.y>this._bounds.y&&i.y<this.gameSize.height+this._bounds.y&&i.x<this.gameSize.width+this._bounds.x?(Object.assign(e,i),!0):!1}tryScreenToActualGameScreenPosition(t,e){const i={x:t.x-this._bounds.x+this._x+this._pan.x,y:t.y-this._bounds.y+this._y+this._pan.y},{width:o,height:n}=this.scale.gameSize;return t.x<o&&t.y<n?(Object.assign(e,i),!0):!1}screenToBoundsPos(t){return{x:t.x+this._bounds.x,y:t.y+this._bounds.y}}worldToTilePos(t,e=!1){return e?{x:Math.max(0,Math.round((t.x-this._bounds.x)/this.tileSize.width)),y:Math.max(0,Math.round((t.y-this._bounds.y)/this.tileSize.height))}:{x:Math.max(0,Math.round(t.x/this.tileSize.width)),y:Math.max(0,Math.round(t.y/this.tileSize.height))}}tilePosToWorld(t){return{x:this._bounds.x+t.x*this.tileSize.width,y:this._bounds.y+t.y*this.tileSize.height}}}class I extends Phaser.GameObjects.Sprite{}I.registeredName="staticSprite";const st=()=>Phaser.GameObjects.GameObjectFactory.register(I.registeredName,function(s,t,e,i){return new I(this.scene,s,t,e,i).setScrollFactor(0)});function ot(){st()}const C={key:"mapOverlay",url:"assets/UI/mapOverlay.png"},nt={key:"game-atlas",url:"assets/game-atlas/texture.png",jsonUrl:"assets/game-atlas/texture.json"};class rt{constructor(t){this.gameWorld=t}}class at{constructor(t){this.gameWorld=t}}const ht=(s,t,e,i,o)=>{const n=s.add.graphics(),r=3,c=.7;return n.redraw=(a,l,d)=>{n.clear(),n.lineStyle(r,o,c);const h=(l.width-d.width)/2,p=(l.height-d.height)/2;n.strokeRect(h+5,p+5,a.width,a.height)},n.redraw(t,e,i),n},ct=(s,t,e)=>{const i=s.add.graphics(),o=3,n=.7;return i.redraw=r=>{i.clear(),i.lineStyle(o,e,n),i.strokeRect(r.x,r.y,r.width,r.height)},i.redraw(t),i};function F(s){try{const e=atob(s),i=e.length,o=new Array(i);for(var t=0;t<e.length;t+=4)o[t/4]=(e.charCodeAt(t)|e.charCodeAt(t+1)<<8|e.charCodeAt(t+2)<<16|e.charCodeAt(t+3)<<24)>>>0;return o}catch(e){throw console.log("Couldn't convert to byte array: "+e),e}}class lt extends Phaser.GameObjects.Sprite{constructor(t,e,i,o){super(t,e,i,o),this.displayHeight=128,this.displayWidth=128,this.setDepth(100),this.play(`${o}-anim`)}}class dt{constructor(t,e){this.gameWorld=t,this._position={x:0,y:0},this._direction={x:0,y:0},this.moveSpeed=4,setTimeout(()=>this.position=e)}get position(){return this._position}set position(t){this._position=t,this.onPositionUpdated&&this.onPositionUpdated()}get direction(){return this._direction}set direction(t){this._direction=t,this.onDirectionUpdated&&this.onDirectionUpdated()}}class x extends dt{onPositionUpdated(){const e=this.gameWorld.findGameObjectByGameObject(x,i=>i===this).graphics;if(e&&!!e.setPosition){const{x:i,y:o}=this.position;e.setPosition(i,o)}}onDirectionUpdated(){const e=this.gameWorld.findGameObjectByGameObject(x,i=>i===this).graphics;if(e&&e.flipX!==void 0){const{x:i}=this.direction;e.flipX=i<0}}}const pt=(s,t)=>{switch(t.className){case"ship":case"Ship":return new x(s,{x:t.initialPosition.x,y:t.initialPosition.y})}return{}},L=(s,t,e)=>{switch(t.className){case"ship":case"Ship":const i="player-ship1";return{createObject:()=>{const o=e.textures.get(i).getFrameNames();return e.anims.create({key:`${i}-anim`,frames:o.map(n=>({key:i,frame:n})),frameRate:4,repeat:-1}),new lt(e,0,0,i)},preload:()=>{e.load.atlas(i,`assets/ships/${i}.png`,`assets/ships/${i}.json`)}};default:return{createObject(){return e.add.circle(0,0,8,6750054).setOrigin(.5,.5)},preload(){}}}},H={width:800,height:600},G={width:666,height:496},g=nt;class mt{constructor(t){this.scene=t,this._events=new z([P.OnResize]),this.layers=[],this._xyOffset={x:0,y:0}}get events(){return this._events}get XyOffset(){return this._xyOffset}get waveTime(){return Math.sin(this.scene.game.getTime()/1e3*1.6)*12}get mapOverlaySize(){const t=this.scene.scale.gameSize,e=t.width/H.width,i=t.height/H.height;return{width:G.width*e,height:G.height*i}}get add(){return this.scene.add}preload(t){this.world=t,this._xyOffset={x:Math.floor((this.scene.scale.gameSize.width-this.mapOverlaySize.width)/2),y:Math.floor((this.scene.scale.gameSize.height-this.mapOverlaySize.height)/2)},this.scene.load.image(C.key,C.url),this.scene.load.atlas(g.key,g.url,g.jsonUrl),this.scene.scale.on("resize",this.resize,this),this.internalGameObjectsFacade(e=>{console.log("Should preload island object",e)},e=>{console.log("Should preload city object",e)},e=>{L(this.world,e,this.scene).preload()})}create(){this.spr_mapBackground=this.scene.add.tileSprite(0,0,Math.max(this.world.worldDefinition.worldSizeInPixels.width+this._xyOffset.x+u,this.scene.scale.displaySize.width),Math.max(this.world.worldDefinition.worldSizeInPixels.height+this._xyOffset.y+u,this.scene.scale.displaySize.height),g.key,"\u041C\u043E\u0440\u0435.\u0444\u043E\u043D2.png").setOrigin(0),this.spr_waves=this.scene.add.tileSprite(0,0,Math.max(this.world.worldDefinition.worldSizeInPixels.width+this._xyOffset.x+u,this.scene.scale.displaySize.width),Math.max(this.world.worldDefinition.worldSizeInPixels.height+this._xyOffset.y+u,this.scene.scale.displaySize.height),g.key,"\u0432\u043E\u043B\u043D\u044B1.2.png").setOrigin(0).setTileScale(.4),this.layers.push(this.scene.add.layer([this.spr_mapBackground,this.spr_waves]).disableInteractive()),this.spr_gameRectFrame=ht(this.scene,this.world.worldDefinition.worldSizeInPixels,this.scene.scale.gameSize,this.mapOverlaySize,6250240);const t=this.scene.add.layer();this.layers.push(t),this.internalGameObjectsFacade(e=>{const i=this.scene.add.sprite(this._xyOffset.x+e.position.x,this._xyOffset.y+e.position.y+this.world.worldDefinition.tileSize.height,"islands",e.tileName).setOrigin(0,1);this.world.objects.push({difinitionData:e,graphics:t.add(i),gameObject:new at(this.world),type:O.Sprite,gameComponents:[]})},e=>{const i=this.scene.add.circle(this._xyOffset.x+e.position.x,this._xyOffset.y+e.position.y+this.world.worldDefinition.tileSize.height*.5,this.world.worldDefinition.tileSize.width,6711039).setInteractive({cursor:"pointer"}).setAlpha(.3).setOrigin(.5,.5);i.on("pointerover",()=>{i.setScale(.95)}),i.on("pointerout",()=>{i.setScale(1)}),this.world.objects.push({difinitionData:e,graphics:t.add(i),gameObject:new rt(this.world),type:O.Circle,gameComponents:[]})},e=>{const i=L(this.world,e,this.scene);this.world.objects.push({difinitionData:e,graphics:t.add(i.createObject()),gameObject:pt(this.world,e),type:O.Circle,gameComponents:[]})}),this.spr_ui_mapOverlay=this.scene.add.image(0,0,C.key).setOrigin(0,0).setScrollFactor(0),this.spr_internalGameFrame=ct(this.scene,f(f({},this._xyOffset),this.mapOverlaySize),12158256).setScrollFactor(0),this.spr_compass=this.scene.add.staticSprite(this._xyOffset.x+10,this._xyOffset.y+10,g.key,"\u043A\u043E\u043C\u043F\u0430\u0441.png").setScale(1).setOrigin(0,0),this.layers.push(this.scene.add.layer(this.spr_compass).disableInteractive()),this.applyScales()}update(t,e){this.spr_waves.setTilePosition(this.waveTime,this.spr_waves.tilePositionY)}addToLayer(t,e){return this.layers[e].add(t),t.on("destroy",()=>this.layers[e].remove(t)),t}resize(t,e,i){this.applyScales()}applyScales(){var r,c,a,l,d;this._xyOffset={x:Math.floor((this.scene.scale.gameSize.width-this.mapOverlaySize.width)/2),y:Math.floor((this.scene.scale.gameSize.height-this.mapOverlaySize.height)/2)};const t=this.scene.scale.gameSize.width/this.scene.scale.displaySize.height;let{width:e,height:i,aspectRatio:o}=this.scene.scale.gameSize;this.scene.cameras.resize(e,i);const n=e<780?96:128;(r=this.spr_compass)==null||r.setDisplaySize(n,n),(c=this.spr_mapBackground)==null||c.setTileScale(t/4*o),(a=this.spr_ui_mapOverlay)==null||a.setDisplaySize(e,i),(l=this.spr_internalGameFrame)==null||l.redraw(f(f({},this._xyOffset),this.mapOverlaySize)),(d=this.spr_gameRectFrame)==null||d.redraw(this.world.worldDefinition.worldSizeInPixels,this.scene.scale.gameSize,this.mapOverlaySize),this.events.emit(P.OnResize)}internalGameObjectsFacade(t,e,i){for(let o of this.world.worldDefinition.islands)t(o);for(let o of this.world.worldDefinition.cities)e(o);for(let o of this.world.worldDefinition.objects)i(o)}}var v=(s=>(s[s.Background=0]="Background",s[s.GameObjects=1]="GameObjects",s[s.UI=2]="UI",s))(v||{}),O=(s=>(s[s.Unknown=0]="Unknown",s[s.Sprite=1]="Sprite",s[s.Circle=2]="Circle",s))(O||{}),P=(s=>(s[s.Unknown=0]="Unknown",s[s.OnResize=1]="OnResize",s))(P||{});const W=function(s,t,e){return e=e<0?0:e,e=e>1?1:e,s+(t-s)*e};class B{constructor(t,e){this.camera=t,this.movableObject=e,this._pathIndex=0,this._pathLerp=0,this._pathToFollow=null,this._onPathIndexHasChangedEvents=[],this._onStopEvents=[]}addPathIndexHasChanged(t){return this._onPathIndexHasChangedEvents.push(t),()=>this._onPathIndexHasChangedEvents.filter(e=>e!=t)}addStopListener(t){return this._onStopEvents.push(t),()=>this._onStopEvents.filter(e=>e!=t)}update(t,e){if(!!this._pathToFollow)try{if(this._pathLerp<1){this._pathLerp+=e/1e3*this.movableObject.gameObject.moveSpeed,this._pathLerp>1&&(this._pathLerp=1);const{x:i,y:o}=this._startMoveFrom,[n,r]=this._pathToFollow[this._pathIndex+1],c=this.camera.tilePosToWorld({x:n,y:r}),a=this.movableObject.gameObject.position,l={x:W(i,c.x,this._pathLerp),y:W(o,c.y,this._pathLerp)};this.movableObject.gameObject.position=l,this.movableObject.gameObject.direction={x:l.x-a.x,y:l.y-a.y},this._pathLerp===1&&(this._pathIndex++,this._onPathIndexHasChangedEvents.forEach(d=>d(this._pathIndex)),this._startMoveFrom=this.movableObject.gameObject.position,this._pathToFollow.length-1<=this._pathIndex?this.stop():this._pathLerp=0)}}catch(i){console.error("failed in pathfind",i),this.stop()}}moveByPath(t){t.length>1?(this._pathIndex=0,this._pathLerp=0,this._pathToFollow=t,this._startMoveFrom=this.movableObject.gameObject.position):this.stop()}stop(){this._pathIndex=0,this._pathLerp=1,this._pathToFollow=null,this._onStopEvents.forEach(t=>t())}}const E=!0;class ut{constructor(t,e,i,o,n){if(this.render=t,this.control_input=e,this.control_camera=i,this.control_pathfind=o,this.ship=n,this.lines=[],this.mover=n.gameComponents.find(r=>r instanceof B),!this.mover)throw new Error("Can't find PathfindMover component in ship");this.control_input.on(A.Click,this.moveShip.bind(this)),this.mover.addPathIndexHasChanged(this.shipHasMovedByPath.bind(this)),this.mover.addStopListener(this.shipHasStopped.bind(this))}moveShip(t,e,i){let o={x:0,y:0},n={x:0,y:0};if(!t&&e<.15&&this.control_camera.tryScreenToGamaPosition(i,o)&&this.control_camera.tryScreenToActualGameScreenPosition(i,n)){this.gr_moveToIndicator&&(this.gr_moveToIndicator.destroy(),this.gr_moveToIndicator=void 0),this.gr_moveToIndicator=this.render.addToLayer(this.render.add.circle(o.x,o.y,5,6750054,1).setDepth(10),v.GameObjects);const r=this.control_camera.worldToTilePos(n);try{const{x:a,y:l}=this.control_camera.worldToTilePos(this.ship.gameObject.position,!0),d=this.control_pathfind.findPath({x:a,y:l},r);if(E&&(this.lines.forEach(h=>h.destroy()),this.lines.length=0),d!=null&&d.length){if(E){const h=this.control_camera.tileSize;for(let p=0;p<d.length;p++){const[m,y]=d[p],_=this.control_camera.tilePosToWorld({x:m,y}),b=this.render.addToLayer(this.render.add.circle(_.x+h.width/2,_.y+h.height/2,5,16711680,1),v.GameObjects);this.lines.push(b)}}this.mover.moveByPath(d)}else this.mover.stop()}catch(c){console.error(c)}}}shipHasMovedByPath(t){var e,i;if(((e=this.lines)==null?void 0:e.length)>0){const o=(i=this.lines)==null?void 0:i.shift();o==null||o.destroy()}}shipHasStopped(){this.lines.forEach(t=>t.destroy()),this.lines.length=0}}class U{constructor(t,e,i,o){this.name=t,this.className=e,this.initialPosition=i,this.properties=o}}class _t{constructor(t){this.worldDefinition=t,this.objects=[]}update(t,e){for(let i of this.objects)if(i.gameComponents.length)for(let o of i.gameComponents)o.update&&o.update(t,e)}findGameObject(t){return this.objects.find(e=>e.gameObject instanceof t)}findGameObjectByGameObject(t,e){return this.objects.find(i=>i.gameObject instanceof t&&e(i.gameObject))}findGameObjectWithPropertry(t,e){return this.objects.find(i=>{var o;return i.gameObject instanceof t&&i.difinitionData instanceof U&&((o=i.difinitionData.properties)==null?void 0:o.find(n=>e(n)))})}}class ft{constructor(t,e){this.name=t,this.position=e}}class gt{constructor(t,e){this.tileName=t,this.position=e}}const yt={width:960,height:1240};class wt{constructor(t="DefaultWorldName",e=yt,i={width:32,height:32},o={width:32,height:32}){this.worldName=t,this.worldSize=e,this.tileSize=i,this.tilesCount=o,this.islands=[],this.cities=[],this.objects=[],this.collisionData=[]}get worldSizeInPixels(){return{width:this.worldSize.width*this.tileSize.width,height:this.worldSize.height*this.tileSize.height}}}const D=s=>new Promise((t,e)=>{s.on("filecomplete",(i,o,n)=>t(n)).on("loaderror",e),s.start()});class xt{constructor(t,e,i,o,n,r,c){this.name=t,this.images=[],this.total=0,this.maxId=0,(i===void 0||i<=0)&&(i=32),(o===void 0||o<=0)&&(o=32),n===void 0&&(n=0),r===void 0&&(r=0),this.firstgid=e|0,this.imageWidth=i|0,this.imageHeight=o|0,this.imageMargin=n|0,this.imageSpacing=r|0,this.properties=c||{}}containsImageIndex(t){return t>=this.firstgid&&t<this.firstgid+this.total}addImage(t,e){return this.images.push({gid:t,image:e}),this.total++,this}}const bt="current-map",St=async(s,t,e,i)=>{var a,l,d;const o=await D(i.json(bt,s)),n=t.map(h=>e.get(h)),r=new wt((l=(a=o.properties)==null?void 0:a.find(h=>h.name==="name"))==null?void 0:l.value,{width:o.width,height:o.height},{width:o.tilewidth,height:o.tileheight}),c=n.map(h=>At(h,o));for(const h of o.layers)switch(h.name){case"collision":{const p=F(h.data);r.collisionData.push(...p)}break;case"islands":{const p=F(h.data),m=Ot(p,h.width),y=c.find(_=>_.name==="map1_tileset_islands1.json");for(let _ of m){const b=(d=y==null?void 0:y.images.find(N=>N.gid===_.val))==null?void 0:d.image;if(!b)continue;const R=new gt(b,{x:Math.floor(_.x*r.tileSize.width),y:Math.floor(_.y*r.tileSize.height)});r.islands.push(R)}}break;default:{const p=h.objects;if(p&&p.length>0)for(const m of p)switch(m.class){case"City":r.cities.push(new ft(m.name,{x:m.x,y:m.y}));break;case"Ship":r.objects.push(new U(m.name,m.class,{x:m.x,y:m.y},m.properties));break}else console.warn(`Layer=${h.name} don't contains objects and it's neither collision nor islands. What should I do with it?`)}break}return r},Ot=(s,t)=>{const e=[];let i=-1,o=0;for(let n=0;n<s.length;n++)i++,i>=t&&(o++,i=0),s[n]&&e.push({x:i,y:o,val:jt(s[n])});return e},vt=2147483648,Pt=1073741824,zt=536870912;function jt(s){return s=s&~(vt|Pt|zt),s}function At(s,t){const e=t.tilesets.find(a=>a.source===s.name);if(!e)throw new Error(`Can't find ${s.name} in map!`);const i=new xt(s.name,e.firstgid,s.tilewidth,s.tileheight,s.margin,s.spacing,s.properties);let o=0;for(let a=0;a<s.tiles.length;a++){let l=s.tiles[a];var n=l.image.replace(/^.*[\\\/]/,""),r=parseInt(l.id,10),c=e.firstgid+r;i.addImage(c,n),o=Math.max(r,o)}return i.maxId=o,i}const Ct=s=>{const t=new Array(s.tilesCount.height);for(let e=0;e<s.worldSize.height;e++){t[e]=new Array(s.worldSize.width);for(let i=0;i<s.worldSize.width;i++)t[e][i]=s.collisionData[i+e*s.worldSize.width]===0?0:1}return t};class It extends w.Scene{constructor(){super("GameScene"),this.render=new mt(this)}preload(){this.load.rexAwait(async(t,e)=>{try{await D(this.load.json("glBlocks","assets/maps/map1_tileset_blockColl.json")),await D(this.load.json("islandBlocks","assets/maps/map1_tileset_islands1.json"));const i=await St("assets/maps/map1.json",["glBlocks","islandBlocks"],this.game.cache.json,this.load);this.world=new _t(i),this.load.atlas("islands","assets/game-atlas/islands.png","assets/game-atlas/islands.json"),this.render.preload(this.world),t()}catch(i){console.error("preload error!",i),e(i)}})}create(){this.render.create(),this.control_camera=new it(this.game,this.scale,this.cameras.main,this.control_input,this.world.worldDefinition.worldSizeInPixels,this.world.worldDefinition.tileSize),this.control_input=new et(this.sys,this.scene,this.input,this.control_camera),this.control_pathfind=new q.AStarFinder({grid:{matrix:Ct(this.world.worldDefinition)}}),this.render.events.on(P.OnResize,()=>{this.control_camera.resize({x:this.render.XyOffset.x,y:this.render.XyOffset.y,width:this.render.mapOverlaySize.width,height:this.render.mapOverlaySize.height})}),this.debug_text=this.render.addToLayer(this.add.text(25,25,"v: 0.1.1").setColor("black").setScrollFactor(0,0),v.UI);const t=this.world.findGameObjectWithPropertry(x,e=>e.name==="isPlayer"&&!!e.value);this.control_camera.lookAtObject(t.gameObject),t.gameComponents.push(new B(this.control_camera,t)),t.gameComponents.push(new ut(this.render,this.control_input,this.control_camera,this.control_pathfind,t))}update(t,e){this.control_camera.update(t,e),this.control_input.update(t,e),this.render.update(t,e);const i=10,o=this.control_input.direction;this.control_camera.updatePosition(o.x*i,o.y*i),this.world.update(t,e)}}ot();const Dt={type:w.WEBGL,parent:"game",backgroundColor:"#33A5E7",scale:{width:1920,height:1080,mode:w.Scale.FIT,autoCenter:w.Scale.CENTER_BOTH},fps:{target:60,forceSetTimeOut:!0},plugins:{global:[{key:"rexAwaitLoader",plugin:K,start:!0}]}};new w.Game(T(f({},Dt),{scene:[It]}));
